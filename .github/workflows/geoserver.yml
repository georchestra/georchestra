name: Geoserver CI

on:
  push:
    branches:
      - add-github-actions
      - master
      - 19.04
      - 18.06

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      #  with:
      #     submodule: recursive
      # we use this action because adding submodule: recursive to the checkout action doesn't work with
      - uses: textbook/git-checkout-submodule-action@2.0.0
      - uses: actions/setup-java@v1
        with:
          java-version: '8.x'
      - name: add georchestra artifactory to local m2 (temporary, need to move to proper action)
        run: |
          mkdir $HOME/.m2
          echo $M2_SETTINGS_FILE > $HOME/.m2/settings.xml
        env:
          M2_SETTINGS_FILE: ${{ secrets.M2_SETTINGS_FILE }}
      # this is usefull for general plugins for example, docker one.
      - name: installing root pom into .m2
        run: ./mvnw install --non-recursive
      - name: install
        working-directory: geoserver/
        run: ../mvnw -X --no-transfer-progress -B clean install -DskipTests
      - name: build & publish docker image
        working-directory: geoserver/
        run: ../mvnw --no-transfer-progress clean package docker:build -Pdocker
      #      This is not working properly right now, commenting.
      #      - name: publish docker image
      #        working-directory: geoserver/
      #        run: ../mvnw --no-transfer-progress docker:push -Pdocker
      - name: publish on github package repository
        working-directory: geoserver/
        run: ../mvnw --no-transfer-progress deploy -Dtoken=${{ secrets.GITHUB_TOKEN }}
